# ベイズ推論モジュール 要件定義書

## 1. 背景と目的
### 背景
現在 `evidec` は頻度論的な仮説検定（z検定/t検定）に基づいた AB テスト評価機能を提供している。
しかし、ビジネス現場では「有意差が出るまで待てない」「結局どのくらいの確率で改善するのか知りたい」というニーズがあり、頻度論的な p値だけでは直感的な意思決定が難しい場面がある。

### 目的
Beta-Binomial モデルによる CVR 等の比率指標に対するベイズ推定機能を追加する。
事後分布から得られる「改善確率」や「リフトの確からしさ」を提示することで、ビジネス意思決定（GO / SAFE / NO-GO）をより柔軟かつ定量的に支援することを目的とする。

## 2. 機能要件

### 2.1 ベイズ推定モデル
- **対象データ**: 比率（Proportion）データ（例: CVR, CTR）。
  - 入力は対照群（Control）と処置群（Treatment）それぞれの「成功数」と「試行数」。
- **採用モデル**: Beta-Binomial モデル（二項分布の尤度 + Beta 分布の事前分布）。
- **事前分布**:
  - ユーザーがパラメータ（$\alpha, \beta$）を指定可能とする。
  - デフォルトは無情報事前分布（一様分布相当）とする。

### 2.2 算出指標
ベイズ推定の結果として、以下の指標を提供すること。

1.  **改善確率 (Probability of Improvement)**:
    - 処置群の指標が対照群を上回っている確率。
2.  **非劣性確率/許容確率 (Probability of Being Safe)**:
    - 処置群の指標が「許容できない悪化ライン（Tolerance）」より上にある確率。
3.  **リフトの推定 (Estimated Lift)**:
    - リフト（差分）の期待値。
    - リフトの不確実性を表す区間（信用区間）。

### 2.3 レポート出力
- 既存の `EvidenceReport`（Markdown レポート）に、ベイズ分析の結果を追記できること。
- 頻度論的な検定結果（既存機能）とベイズ分析結果（新機能）は併記可能とする。
- ベイズ分析を行わない場合は、従来通りのレポートが出力されること（後方互換性）。

## 3. 非機能要件
- **パフォーマンス**: 通常の AB テスト分析（数万〜数百万サンプル）において、数秒以内で結果が返ること。
- **再現性**: 乱数シードを指定することで、同一の計算結果が再現できること。
- **API 互換性**: 既存の `Experiment` や `StatResult` のインターフェースを破壊しないこと。

## 4. 意思決定ガイドライン（参考）
本機能を用いた意思決定の推奨基準は以下の通りとする（ユーザーがパラメータ調整可能であること）。

| 判定 | 条件イメージ | ビジネス解釈 |
| :--- | :--- | :--- |
| **GO** | 悪化リスクが極めて低く、かつ改善確率が高い | 導入を推奨。期待リターンがプラスでありリスクも小さい。 |
| **SAFE** | 悪化リスクは低いが、改善確率は決定的ではない | 導入しても悪影響はない（非劣性）。他の要因（UX等）で判断可。 |
| **NO-GO** | 悪化リスクが高い | 導入すべきでない。既存の指標を下回る可能性が高い。 |

## 5. スコープ外
- 連続値指標（売上、滞在時間など）に対するベイズ推定。
- 階層ベイズモデルや多変量テストへの対応。
- 逐次検定（Sequential Testing）のロジック。
